<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>后台管理系统 - 东方美谷韩国中心</title>
    <link rel="icon" type="image/png" href="images/logo.jpg">
    <link rel="stylesheet" href="styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@300;400;500;700&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <!-- SheetJS 库用于导出 Excel -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <style>
        /* 简约后台管理样式 */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Noto Sans SC', sans-serif;
            background: #f5f6fa;
            color: #333;
        }

        .admin-container {
            min-height: 100vh;
            background: #f5f6fa;
            padding: 20px;
        }

        .admin-header {
            background: white;
            border-radius: 8px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            border-left: 4px solid #667eea;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .header-left {
            flex: 0 0 auto;
        }

        .header-center {
            flex: 1;
            text-align: center;
        }

        .header-right {
            flex: 0 0 auto;
        }

        .company-logo {
            display: flex;
            align-items: center;
            cursor: pointer;
            transition: all 0.3s ease;
            padding: 8px 12px;
            border-radius: 6px;
        }

        .company-logo:hover {
            background: #f8f9fa;
            transform: scale(1.05);
        }

        .company-logo .logo-img {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            margin-right: 12px;
            object-fit: cover;
        }

        .company-logo .logo-text {
            font-size: 1.2rem;
            font-weight: 600;
            color: #333;
        }

        .admin-header h1 {
            font-size: 2rem;
            color: #333;
            margin-bottom: 8px;
            font-weight: 600;
        }

        .admin-header p {
            color: #666;
            font-size: 1rem;
        }

        .logout-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: background 0.3s ease;
        }

        .logout-btn:hover {
            background: #c82333;
        }

        /* 权限系统样式 */
        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-right: 20px;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea, #764ba2);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 1.1rem;
        }

        .user-details {
            display: flex;
            flex-direction: column;
        }

        .user-name {
            font-weight: 600;
            color: #333;
            font-size: 0.95rem;
        }

        .user-role {
            font-size: 0.8rem;
            color: #666;
            padding: 2px 8px;
            border-radius: 10px;
            background: #f0f0f0;
            width: fit-content;
        }

        .user-role.super-admin {
            background: #ff6b6b;
            color: white;
        }

        .user-role.admin {
            background: #4ecdc4;
            color: white;
        }

        .user-role.user {
            background: #95a5a6;
            color: white;
        }

        /* 日志查看器样式 */
        .log-viewer {
            background: white;
            border-radius: 8px;
            padding: 30px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            margin-top: 20px;
            width: 100%;
            min-height: 400px;
            height: auto;
            display: block;
        }

        .log-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 1px solid #e9ecef;
        }

        .log-filters {
            display: flex;
            gap: 15px;
            align-items: center;
            margin-bottom: 20px;
        }

        .log-filter {
            padding: 8px 15px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background: white;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .log-filter:hover {
            border-color: #667eea;
            background: #f8f9fa;
        }

        .log-filter.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .log-list {
            max-height: 500px;
            min-height: 200px;
            height: auto;
            width: 100%;
            overflow-y: auto;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            background: white;
        }

        .log-item {
            padding: 15px 20px;
            border-bottom: 1px solid #f0f0f0;
            display: flex;
            align-items: center;
            gap: 15px;
            transition: background 0.3s ease;
        }

        .log-item:hover {
            background: #f8f9fa;
        }

        .log-item:last-child {
            border-bottom: none;
        }

        .log-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            color: white;
        }

        .log-icon.create {
            background: #28a745;
        }

        .log-icon.update {
            background: #ffc107;
        }

        .log-icon.delete {
            background: #dc3545;
        }

        .log-content {
            flex: 1;
        }

        .log-action {
            font-weight: 600;
            color: #333;
            margin-bottom: 4px;
        }

        .log-details {
            font-size: 0.9rem;
            color: #666;
            margin-bottom: 2px;
        }

        .log-time {
            font-size: 0.8rem;
            color: #999;
        }

        .log-user {
            font-size: 0.85rem;
            color: #667eea;
            font-weight: 500;
        }

        .empty-logs {
            text-align: center;
            padding: 40px;
            color: #999;
        }

        .empty-logs i {
            font-size: 3rem;
            margin-bottom: 15px;
            opacity: 0.5;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            margin-bottom: 30px;
            max-width: 600px;
            margin-left: auto;
            margin-right: auto;
        }

        .stat-card {
            background: white;
            border-radius: 8px;
            padding: 25px;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            border-top: 3px solid #667eea;
        }

        .stat-number {
            font-size: 2.5rem;
            font-weight: 700;
            color: #667eea;
            margin-bottom: 8px;
        }

        .stat-label {
            color: #666;
            font-size: 0.9rem;
        }

        /* 标签页样式 */
        .admin-tabs {
            display: flex;
            gap: 0;
            margin-bottom: 30px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            overflow: hidden;
        }

        .tab-btn {
            flex: 1;
            background: white;
            border: none;
            padding: 20px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 500;
            color: #666;
            transition: all 0.3s ease;
            border-bottom: 3px solid transparent;
        }

        .tab-btn:hover {
            background: #f8f9fa;
            color: #333;
        }

        .tab-btn.active {
            color: #667eea;
            border-bottom-color: #667eea;
            background: #f8f9fa;
        }

        .tab-btn i {
            margin-right: 8px;
        }

        .admin-main {
            max-width: 1200px;
            margin: 0 auto;
        }

        .admin-card {
            background: white;
            border-radius: 8px;
            padding: 30px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            display: none;
        }

        .admin-card.active {
            display: block;
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 1px solid #e9ecef;
        }

        .card-title {
            font-size: 1.3rem;
            color: #333;
            font-weight: 600;
        }

        .add-btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 500;
            transition: background 0.3s ease;
        }

        .add-btn:hover {
            background: #5a6fd8;
        }

        .content-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-bottom: 50px;
            max-width: 800px;
            margin-left: auto;
            margin-right: auto;
        }

        .admin-article-item {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            transition: all 0.3s ease;
            border: 1px solid #f0f0f0;
            padding: 20px 25px;
        }

        .admin-article-item:hover {
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            transform: translateY(-1px);
            border-color: #ff6900;
        }

        .article-link-content {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .article-link-meta {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 12px;
        }

        .article-link-category {
            background: #ff6900;
            color: white;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .article-link-date {
            color: #999;
            font-size: 0.9rem;
        }



        .article-link-title {
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 8px;
            color: #333;
            line-height: 1.4;
            transition: color 0.3s ease;
        }

        .admin-article-item:hover .article-link-title {
            color: #ff6900;
        }


        .article-link-desc {
            color: #666;
            font-size: 0.9rem;
            line-height: 1.5;
            margin-bottom: 15px;
        }

        .article-link-actions {
            display: flex;
            gap: 10px;
            margin-top: auto;
        }

        .article-link-actions .action-btn {
            padding: 6px 12px;
            border-radius: 4px;
            font-size: 0.8rem;
            gap: 4px;
            border: none;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
        }

        .article-link-actions .edit-btn {
            background: #667eea;
            color: white;
        }

        .article-link-actions .edit-btn:hover {
            background: #5a6fd8;
        }

        .article-link-actions .delete-btn {
            background: #e74c3c;
            color: white;
        }

        .article-link-actions .delete-btn:hover {
            background: #c0392b;
        }

        .article-link-actions .view-btn {
            background: #27ae60;
            color: white;
        }

        .article-link-actions .view-btn:hover {
            background: #229954;
        }

        /* 图片和视频预览样式 */
        .image-preview,
        .video-preview {
            margin-top: 10px;
            max-width: 200px;
            max-height: 150px;
            border-radius: 8px;
            overflow: hidden;
            display: none;
        }

        .image-preview img,
        .video-preview video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .image-preview.show,
        .video-preview.show {
            display: block;
        }

        /* 新闻详情样式 */
        .news-details {
            margin: 15px 0;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }

        .news-detail-item {
            margin-bottom: 8px;
            font-size: 0.9rem;
            line-height: 1.4;
        }

        .news-detail-item:last-child {
            margin-bottom: 0;
        }

        .news-detail-item strong {
            color: #333;
            margin-right: 8px;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #999;
        }

        .empty-state i {
            font-size: 3rem;
            margin-bottom: 15px;
            color: #ddd;
        }

        .empty-state h3 {
            margin-bottom: 10px;
            color: #666;
        }

        /* 模态框样式 */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: white;
            border-radius: 8px;
            padding: 30px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 1px solid #e9ecef;
        }

        .modal-title {
            font-size: 1.3rem;
            color: #333;
            margin: 0;
            font-weight: 600;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #999;
            padding: 5px;
        }

        .modal-close:hover {
            color: #333;
        }

        .modal-body {
            margin-bottom: 25px;
        }

        /* 统一模态框内表单控件样式 */
        .modal-body .form-group {
            margin-bottom: 16px;
        }

        .modal-body .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }

        .modal-body input[type="text"],
        .modal-body input[type="url"],
        .modal-body input[type="date"],
        .modal-body input[type="time"],
        .modal-body input[type="file"],
        .modal-body select,
        .modal-body textarea {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 1rem;
            box-sizing: border-box;
        }

        .modal-footer {
            display: flex;
            gap: 15px;
            justify-content: flex-end;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5a6fd8;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #545b62;
        }

        /* 响应式设计 */
        @media (max-width: 768px) {
            .admin-container {
                padding: 15px;
            }

            .admin-header {
                padding: 20px;
                flex-direction: column;
                gap: 20px;
            }

            .header-left,
            .header-center,
            .header-right {
                flex: none;
                width: 100%;
            }

            .header-center {
                order: 1;
            }

            .header-left {
                order: 2;
                text-align: center;
            }

            .header-right {
                order: 3;
                text-align: center;
            }

            .admin-header h1 {
                font-size: 1.5rem;
            }

            .company-logo {
                justify-content: center;
            }

            .logout-btn {
                width: 100%;
                max-width: 200px;
            }

            .admin-tabs {
                flex-direction: column;
            }

            .tab-btn {
                border-bottom: none;
                border-right: 3px solid transparent;
            }

            .tab-btn.active {
                border-bottom: none;
                border-right-color: #667eea;
            }

            .admin-card {
                padding: 20px;
            }

            .stats-grid {
                grid-template-columns: 1fr;
                gap: 15px;
                max-width: 300px;
            }

            .content-list {
                grid-template-columns: 1fr;
                gap: 20px;
            }

            .item-image {
                height: 150px;
            }

            .item-content-wrapper {
                padding: 15px;
            }

            .item-title {
                font-size: 1.1rem;
            }

            .item-actions {
                justify-content: flex-start;
                flex-wrap: wrap;
            }

            .modal-content {
                padding: 20px;
            }
        }

        /* 滚动条样式 */
        .content-list::-webkit-scrollbar {
            width: 6px;
        }

        .content-list::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 3px;
        }

        .content-list::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 3px;
        }

        .content-list::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }

        /* 通知样式 */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 4px;
            color: white;
            font-weight: 500;
            z-index: 10000;
            max-width: 300px;
        }

        .notification.success {
            background: #28a745;
        }

        .notification.error {
            background: #dc3545;
        }

        .notification.warning {
            background: #ffc107;
            color: #333;
        }

        .notification.info {
            background: #17a2b8;
        }

        /* 加载动画 */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }
    </style>
</head>

<body>
    <div class="admin-container">
        <!-- 管理界面 -->
        <div id="adminSection">
            <!-- 头部 -->
            <div class="admin-header">
                <div class="header-left">
                    <div class="company-logo" onclick="goToHome()">
                        <img src="images/logo.jpg" alt="东方美谷" class="logo-img">
                        <span class="logo-text">东方美谷</span>
                    </div>
                </div>
                <div class="header-center">
                    <h1><i class="fas fa-cogs"></i> 后台管理系统</h1>
                    <p>东方美谷韩国中心 - 内容管理中心</p>
                </div>
                <div class="header-right">
                    <div class="user-info">
                        <div class="user-avatar" id="userAvatar">A</div>
                        <div class="user-details">
                            <div class="user-name" id="userName">管理员</div>
                            <div class="user-role" id="userRole">admin</div>
                        </div>
                    </div>
                    <button class="logout-btn" onclick="manualRefreshPermissions()"
                        style="background: #28a745; margin-right: 10px;" title="从数据库刷新权限">
                        <i class="fas fa-sync-alt"></i> 刷新权限
                    </button>
                    <button class="logout-btn" onclick="logout()">
                        <i class="fas fa-sign-out-alt"></i> 退出登录
                    </button>
                </div>
            </div>

            <!-- 统计信息 -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-number" id="articleCount">0</div>
                    <div class="stat-label">文章总数</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="newsCount">0</div>
                    <div class="stat-label">新闻总数</div>
                </div>
            </div>

            <!-- 管理标签页 -->
            <div class="admin-tabs">
                <button class="tab-btn active" data-tab="articles" onclick="switchTab('articles')">
                    <i class="fas fa-file-alt"></i>
                    <span>文章管理</span>
                </button>
                <button class="tab-btn" data-tab="news" onclick="switchTab('news')">
                    <i class="fas fa-newspaper"></i>
                    <span>新闻管理</span>
                </button>
                <button class="tab-btn" data-tab="activities" onclick="switchTab('activities')" id="activitiesTabBtn"
                    style="display: none;">
                    <i class="fas fa-calendar-alt"></i>
                    <span>活动展示</span>
                </button>
                <button class="tab-btn" data-tab="logs" onclick="switchTab('logs')" id="logsTabBtn"
                    style="display: none;">
                    <i class="fas fa-history"></i>
                    <span>操作日志</span>
                </button>
            </div>

            <!-- 主要内容 -->
            <div class="admin-main">
                <!-- 文章管理 -->
                <div class="admin-card active" id="articlesTab">
                    <div class="card-header">
                        <h3 class="card-title">文章管理</h3>
                        <button class="add-btn" onclick="openArticleModal()">
                            <i class="fas fa-plus"></i> 添加文章
                        </button>
                    </div>
                    <div class="content-list" id="articlesList">
                        <div class="empty-state">
                            <i class="fas fa-file-alt"></i>
                            <h3>暂无文章</h3>
                            <p>点击"添加文章"开始创建内容</p>
                        </div>
                    </div>
                </div>

                <!-- 新闻管理 -->
                <div class="admin-card" id="newsTab">
                    <div class="card-header">
                        <h3 class="card-title">新闻管理</h3>
                        <button class="add-btn" onclick="openNewsModal()">
                            <i class="fas fa-plus"></i> 添加新闻
                        </button>
                    </div>
                    <div class="content-list" id="newsList">
                        <div class="empty-state">
                            <i class="fas fa-newspaper"></i>
                            <h3>暂无新闻</h3>
                            <p>点击"添加新闻"开始创建内容</p>
                        </div>
                    </div>
                </div>

                <!-- 活动展示 -->
                <div class="admin-card" id="activitiesTab">
                    <div class="card-header">
                        <h3 class="card-title">活动展示</h3>
                        <p style="color: #666; font-size: 0.9rem;">点击活动卡片可跳转到详情页</p>
                    </div>
                    <div class="content-list" id="activitiesList"
                        style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px;">
                        <div class="empty-state">
                            <i class="fas fa-calendar-alt"></i>
                            <h3>暂无活动</h3>
                            <p>在"新闻管理"中添加活动</p>
                        </div>
                    </div>
                </div>

                <!-- 操作日志 -->
                <div class="admin-card" id="logsTab">
                    <div class="log-viewer">
                        <div class="log-header">
                            <h3 class="card-title">操作日志</h3>
                            <div style="display: flex; gap: 10px;">
                                <button class="add-btn" onclick="refreshLogs()" style="background: #28a745;">
                                    <i class="fas fa-sync-alt"></i> 刷新日志
                                </button>
                                <button class="add-btn" onclick="clearLogs()">
                                    <i class="fas fa-trash"></i> 清空日志
                                </button>
                            </div>
                        </div>

                        <!-- 数据导出功能 -->
                        <div class="export-section"
                            style="margin: 20px 0; padding: 20px; background: #f8f9fa; border-radius: 8px;">
                            <h4 style="margin-bottom: 15px; color: #333;">
                                <i class="fas fa-download"></i> 数据导出
                            </h4>
                            <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                                <button class="add-btn" onclick="exportNewsToExcel()" style="background: #17a2b8;">
                                    <i class="fas fa-file-excel"></i> 导出新闻到Excel
                                </button>
                                <button class="add-btn" onclick="exportArticlesToExcel()" style="background: #6f42c1;">
                                    <i class="fas fa-file-excel"></i> 导出文章到Excel
                                </button>
                                <button class="add-btn" onclick="exportAllData()" style="background: #fd7e14;">
                                    <i class="fas fa-database"></i> 导出所有数据
                                </button>
                            </div>
                        </div>

                        <div class="log-filters">
                            <button class="log-filter active" onclick="filterLogs('all')">全部</button>
                            <button class="log-filter" onclick="filterLogs('create')">创建</button>
                            <button class="log-filter" onclick="filterLogs('update')">修改</button>
                            <button class="log-filter" onclick="filterLogs('delete')">删除</button>
                        </div>

                        <div class="log-list" id="logList">
                            <div class="empty-logs">
                                <i class="fas fa-history"></i>
                                <h3>暂无操作记录</h3>
                                <p>系统将自动记录所有操作</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 文章模态框 -->
    <div id="articleModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="articleModalTitle">添加文章</h3>
            </div>
            <div class="modal-body">
                <form id="articleForm">
                    <div class="form-group">
                        <label for="articleTitle">文章标题 *</label>
                        <input type="text" id="articleTitle" name="title" required>
                    </div>
                    <div class="form-group">
                        <label for="articleContent">文章内容 *</label>
                        <textarea id="articleContent" name="content" rows="4" required
                            style="width: 100%; padding: 12px 15px; border: 1px solid #ddd; border-radius: 4px; font-size: 1rem; resize: vertical;"></textarea>
                    </div>
                    <div class="form-group">
                        <label for="articleLink">文章链接 *</label>
                        <input type="url" id="articleLink" name="link" required
                            placeholder="https://mp.weixin.qq.com/s/...">
                    </div>
                    <div class="form-group">
                        <label for="articleCategory">文章分类 *</label>
                        <select id="articleCategory" name="category" required
                            style="width: 100%; padding: 12px 15px; border: 1px solid #ddd; border-radius: 4px; font-size: 1rem;">
                            <option value="">请选择分类</option>
                            <option value="中韩新象">中韩新象</option>
                            <option value="趋势前瞻">趋势前瞻</option>
                            <option value="美谷韩讯">美谷韩讯</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="articleDate">发布日期 *</label>
                        <input type="date" id="articleDate" name="date" required>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('articleModal')">取消</button>
                <button class="btn btn-primary" onclick="saveArticle()">保存</button>
            </div>
        </div>
    </div>

    <!-- 新闻模态框 -->
    <div id="newsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="newsModalTitle">添加新闻</h3>
            </div>
            <div class="modal-body">
                <form id="newsForm">
                    <div class="form-group">
                        <label for="newsTitle">新闻标题 *</label>
                        <input type="text" id="newsTitle" name="title" required placeholder="请输入活动标题">
                    </div>
                    <div class="form-group">
                        <label for="newsSubtitle">副标题（可选）</label>
                        <input type="text" id="newsSubtitle" name="subtitle" placeholder="如：中韩合作新篇章、新时代美妆产业发展等">
                        <small style="color: #999; font-size: 0.9rem;">简短描述，将在标题下方显示</small>
                    </div>
                    <div class="form-group">
                        <label for="newsContent">新闻内容 *</label>
                        <textarea id="newsContent" name="content" rows="4" required
                            style="width: 100%; padding: 12px 15px; border: 1px solid #ddd; border-radius: 4px; font-size: 1rem; resize: vertical;"
                            placeholder="详细描述活动内容、流程和背景"></textarea>
                    </div>
                    <div class="form-group">
                        <label for="newsDate">活动时间 *</label>
                        <input type="date" id="newsDate" name="date" required>
                    </div>
                    <div class="form-group">
                        <label for="newsTime">具体时间</label>
                        <input type="time" id="newsTime" name="time" placeholder="09:00-17:00">
                    </div>
                    <div class="form-group">
                        <label for="newsLocation">活动地点 *</label>
                        <input type="text" id="newsLocation" name="location" required placeholder="上海市奉贤区东方美谷大道1699号">
                    </div>
                    <div class="form-group">
                        <label for="newsOrganizer">主办方 *</label>
                        <input type="text" id="newsOrganizer" name="organizer" required placeholder="东方美谷韩国中心">
                    </div>
                    <div class="form-group">
                        <label for="newsCoOrganizer">联合组织者</label>
                        <input type="text" id="newsCoOrganizer" name="coOrganizer" placeholder="合作伙伴名称">
                    </div>
                    <div class="form-group">
                        <label for="newsCoreFunction">核心功能 *</label>
                        <textarea id="newsCoreFunction" name="coreFunction" rows="3" required
                            style="width: 100%; padding: 12px 15px; border: 1px solid #ddd; border-radius: 4px; font-size: 1rem; resize: vertical;"
                            placeholder="描述活动的核心功能和目标"></textarea>
                    </div>
                    <div class="form-group">
                        <label for="newsHighlights">活动亮点 *</label>
                        <textarea id="newsHighlights" name="highlights" rows="3" required
                            style="width: 100%; padding: 12px 15px; border: 1px solid #ddd; border-radius: 4px; font-size: 1rem; resize: vertical;"
                            placeholder="描述活动的亮点和特色"></textarea>
                    </div>
                    <div class="form-group">
                        <label for="newsEventGoal">活动目标</label>
                        <textarea id="newsEventGoal" name="eventGoal" rows="3"
                            style="width: 100%; padding: 12px 15px; border: 1px solid #ddd; border-radius: 4px; font-size: 1rem; resize: vertical;"
                            placeholder="描述活动的目标和愿景"></textarea>
                    </div>
                    <div class="form-group">
                        <label for="newsParticipants">预期人数</label>
                        <input type="text" id="newsParticipants" name="participants" placeholder="如：100-200人">
                    </div>
                    <div class="form-group">
                        <label for="newsEventScale">活动规模</label>
                        <select id="newsEventScale" name="eventScale"
                            style="width: 100%; padding: 12px 15px; border: 1px solid #ddd; border-radius: 4px; font-size: 1rem;">
                            <option value="">请选择</option>
                            <option value="大型活动">大型活动（500人以上）</option>
                            <option value="中型活动">中型活动（100-500人）</option>
                            <option value="小型活动">小型活动（50-100人）</option>
                            <option value="精品活动">精品活动（50人以下）</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="newsEventFee">活动费用</label>
                        <input type="text" id="newsEventFee" name="eventFee" placeholder="如：免费 / ￥100/人">
                    </div>
                    <div class="form-group">
                        <label for="newsCategory">新闻分类</label>
                        <select id="newsCategory" name="category"
                            style="width: 100%; padding: 12px 15px; border: 1px solid #ddd; border-radius: 4px; font-size: 1rem;">
                            <option value="活动新闻">活动新闻</option>
                            <option value="公司动态">公司动态</option>
                            <option value="行业资讯">行业资讯</option>
                            <option value="产品发布">产品发布</option>
                            <option value="合作签约">合作签约</option>
                            <option value="展会活动">展会活动</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="newsCoverImage">封面图片（首页展示用，不显示在详情页）</label>
                        <input type="file" id="newsCoverImage" name="coverImage" accept="image/*"
                            onchange="previewCover(this, 'newsCoverImagePreview')">
                        <small style="color: #666;">用于在首页和列表页显示，建议尺寸：1200x600px</small>
                        <small style="color: #4299E1; display: block; margin-top: 5px;">💡
                            支持上传最大2MB的图片（建议1MB以内以获得最佳性能）</small>
                        <div id="newsCoverImagePreview" class="image-preview" style="margin-top: 10px;"></div>
                    </div>
                    <div class="form-group">
                        <label for="newsImage">活动图片（可上传多张）</label>
                        <input type="file" id="newsImage" name="image" accept="image/*" multiple
                            onchange="previewImages(this, 'newsImagePreview')">
                        <small style="color: #666;">在活动详情页展示，可上传多张</small>
                        <div id="newsImagePreview" class="image-preview"
                            style="display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 10px; margin-top: 10px;">
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="newsVideo">活动视频（可上传多个）</label>
                        <input type="file" id="newsVideo" name="video" accept="video/*" multiple
                            onchange="previewVideos(this, 'newsVideoPreview')">
                        <small style="color: #666;">在活动详情页展示，可上传多个</small>
                        <div id="newsVideoPreview" class="video-preview"
                            style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 10px; margin-top: 10px;">
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="newsParticipantsList">参与人员（每行一个）</label>
                        <textarea id="newsParticipantsList" name="participantsList" rows="4"
                            style="width: 100%; padding: 12px 15px; border: 1px solid #ddd; border-radius: 4px; font-size: 1rem; resize: vertical;"
                            placeholder="张三&#10;李四&#10;王五"></textarea>
                    </div>
                    <div class="form-group">
                        <label for="newsStaffList">工作人员（每行一个）</label>
                        <textarea id="newsStaffList" name="staffList" rows="4"
                            style="width: 100%; padding: 12px 15px; border: 1px solid #ddd; border-radius: 4px; font-size: 1rem; resize: vertical;"
                            placeholder="赵六（负责人）&#10;钱七（摄影）&#10;孙八（后勤）"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('newsModal')">取消</button>
                <button class="btn btn-primary" onclick="saveNews()">保存</button>
            </div>
        </div>
    </div>

    <script>
        // 工具函数
        function generateId() {
            return uniqid() + Math.random().toString(36).substr(2, 9);
        }

        function uniqid() {
            return Date.now().toString(36) + Math.random().toString(36).substr(2);
        }

        // 全局变量
        let currentEditingArticle = null;
        let currentEditingNews = null;
        let articles = [];
        let news = [];

        // 权限系统
        const PERMISSIONS = {
            USER: 'user',
            ADMIN: 'admin',
            SUPER_ADMIN: 'super-admin'
        };

        let currentUser = {
            username: 'admin',
            role: PERMISSIONS.ADMIN,
            avatar: 'A'
        };

        // 操作日志
        let operationLogs = [];

        // 数据库API集成
        let useDatabase = false;
        let dbConnected = false;

        // 检查数据库连接
        async function checkDatabaseConnection() {
            try {
                if (typeof window.dbAPI !== 'undefined') {
                    const connected = await window.dbAPI.checkConnection();
                    dbConnected = connected;
                    console.log('数据库连接状态:', connected ? '已连接' : '未连接');
                    return connected;
                }
                return false;
            } catch (error) {
                console.log('数据库连接检查失败:', error.message);
                dbConnected = false;
                return false;
            }
        }

        // 初始化数据库连接
        async function initDatabase() {
            try {
                const connected = await checkDatabaseConnection();
                if (connected) {
                    useDatabase = true;
                    console.log('✅ 数据库模式已启用');

                    // 从数据库加载数据
                    await loadDataFromDatabase();
                } else {
                    useDatabase = false;
                    console.log('⚠️ 使用本地存储模式');
                }
            } catch (error) {
                console.error('数据库初始化失败:', error);
                useDatabase = false;
            }
        }

        // 从数据库加载数据
        async function loadDataFromDatabase() {
            try {
                console.log('从数据库加载数据...');

                // 加载文章数据
                const articlesResult = await window.dbAPI.getArticles();
                if (articlesResult.success) {
                    adminData.articles = articlesResult.data.data || [];
                    console.log('✅ 文章数据加载成功:', adminData.articles.length, '篇');
                }

                // 加载新闻数据
                const newsResult = await window.dbAPI.getNews();
                if (newsResult.success) {
                    adminData.news = newsResult.data.data || [];
                    console.log('✅ 新闻数据加载成功:', adminData.news.length, '条');
                }

                // 更新显示
                updateArticlesDisplay();
                updateNewsDisplay();

            } catch (error) {
                console.error('从数据库加载数据失败:', error);
                throw error;
            }
        }

        // 保存文章到数据库
        async function saveArticleToDatabase(articleData) {
            try {
                if (useDatabase && dbConnected) {
                    const result = await window.dbAPI.createArticle(articleData);
                    if (result.success) {
                        console.log('✅ 文章保存到数据库成功');
                        return result.data.id;
                    }
                }
                return null;
            } catch (error) {
                console.error('保存文章到数据库失败:', error);
                return null;
            }
        }

        // 保存新闻到数据库
        async function saveNewsToDatabase(newsData) {
            try {
                if (useDatabase && dbConnected) {
                    const result = await window.dbAPI.createNews(newsData);
                    if (result.success) {
                        console.log('✅ 新闻保存到数据库成功');
                        return result.data.id;
                    }
                }
                return null;
            } catch (error) {
                console.error('保存新闻到数据库失败:', error);
                return null;
            }
        }

        // 删除文章从数据库
        async function deleteArticleFromDatabase(articleId) {
            try {
                if (useDatabase && dbConnected) {
                    const result = await window.dbAPI.deleteArticle(articleId);
                    if (result.success) {
                        console.log('✅ 文章从数据库删除成功');
                        return true;
                    }
                }
                return false;
            } catch (error) {
                console.error('从数据库删除文章失败:', error);
                return false;
            }
        }

        // 删除新闻从数据库
        async function deleteNewsFromDatabase(newsId) {
            try {
                if (useDatabase && dbConnected) {
                    const result = await window.dbAPI.deleteNews(newsId);
                    if (result.success) {
                        console.log('✅ 新闻从数据库删除成功');
                        return true;
                    }
                }
                return false;
            } catch (error) {
                console.error('从数据库删除新闻失败:', error);
                return false;
            }
        }

        // 从数据库刷新用户权限信息
        async function refreshUserPermissions() {
            try {
                const savedUser = localStorage.getItem('currentUser');
                if (!savedUser) return false;

                const user = JSON.parse(savedUser);

                // 尝试从数据库获取最新的用户信息
                const response = await fetch('api/auth.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        action: 'get_user_info',
                        user_id: user.id,
                        username: user.username
                    })
                });

                if (response.ok) {
                    const data = await response.json();
                    if (data.success && data.data) {
                        // 更新用户信息
                        const updatedUser = {
                            id: data.data.id,
                            username: data.data.username,
                            role: data.data.role,
                            avatar: data.data.avatar || user.avatar
                        };

                        // 保存到localStorage
                        localStorage.setItem('currentUser', JSON.stringify(updatedUser));
                        currentUser = updatedUser;

                        console.log('✅ 权限已从数据库刷新:', currentUser.role);
                        return true;
                    }
                }

                return false;
            } catch (error) {
                console.log('从数据库刷新权限失败，使用缓存信息:', error.message);
                return false;
            }
        }

        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', async function () {
            // 检查登录状态
            if (localStorage.getItem('adminLoggedIn') !== 'true') {
                // 未登录，跳转到登录页面
                window.location.href = 'admin-login.html';
                return;
            }

            try {
                // 从localStorage恢复用户信息
                const savedUser = localStorage.getItem('currentUser');
                if (savedUser) {
                    currentUser = JSON.parse(savedUser);
                }

                // 🔥 新增：尝试从数据库刷新权限
                const refreshed = await refreshUserPermissions();
                if (refreshed) {
                    console.log('✅ 已从数据库更新权限');
                } else {
                    console.log('ℹ️ 使用缓存的用户信息');
                }

                // 立即显示管理界面
                showAdminSection();
                updateUserInterface();

                // 并行执行数据加载任务
                const tasks = [
                    initDatabase(),
                    loadData(),
                    loadLogs(),
                    setDefaultDate()
                ];

                // 等待所有任务完成
                await Promise.all(tasks);

            } catch (error) {
                console.error('初始化失败:', error);
                showNotification('数据加载失败，请刷新页面重试', 'error');
            }
        });

        // 显示管理界面
        function showAdminSection() {
            document.getElementById('adminSection').style.display = 'block';
        }

        // 退出登录
        function logout() {
            if (confirm('确定要退出登录吗？\n\n点击"确定"将退出登录并返回首页')) {
                addLog('logout', '用户退出', `用户 ${currentUser.username} 退出系统`);
                localStorage.removeItem('adminLoggedIn');
                localStorage.removeItem('adminUsername');
                localStorage.removeItem('currentUser');
                showNotification('已退出登录，正在返回首页...', 'info');

                // 延迟跳转到首页
                setTimeout(() => {
                    window.location.href = 'index.html';
                }, 1500);
            }
        }

        // 手动刷新权限
        async function manualRefreshPermissions() {
            showNotification('正在从数据库刷新权限...', 'info');

            const refreshed = await refreshUserPermissions();

            if (refreshed) {
                // 更新界面
                updateUserInterface();

                // 根据新权限显示或隐藏日志标签
                const logsTabEl = document.getElementById('logsTabBtn');
                if (logsTabEl && currentUser.role === PERMISSIONS.SUPER_ADMIN) {
                    logsTabEl.style.display = 'block';
                    showNotification(`✅ 权限已更新！您现在是${getRoleDisplayName(currentUser.role)}`, 'success');
                } else {
                    showNotification(`✅ 权限已刷新：${getRoleDisplayName(currentUser.role)}`, 'success');
                }

                // 根据新权限显示或隐藏活动展示标签
                const activitiesTabEl = document.getElementById('activitiesTabBtn');
                if (activitiesTabEl && currentUser.role === PERMISSIONS.SUPER_ADMIN) {
                    activitiesTabEl.style.display = 'block';
                }

                console.log('✅ 手动刷新权限成功:', currentUser);
            } else {
                showNotification('❌ 无法从数据库获取权限信息', 'error');
            }
        }

        // 更新用户界面
        function updateUserInterface() {
            const userNameEl = document.getElementById('userName');
            const userRoleEl = document.getElementById('userRole');
            const userAvatarEl = document.getElementById('userAvatar');
            const logsTabEl = document.getElementById('logsTabBtn');

            if (userNameEl) userNameEl.textContent = currentUser.username;
            if (userRoleEl) {
                userRoleEl.textContent = getRoleDisplayName(currentUser.role);
                userRoleEl.className = `user-role ${currentUser.role}`;
            }
            if (userAvatarEl) userAvatarEl.textContent = currentUser.avatar;

            // 只有超级管理员才能看到日志标签
            if (logsTabEl) {
                logsTabEl.style.display = currentUser.role === PERMISSIONS.SUPER_ADMIN ? 'block' : 'none';
            }

            // 只有超级管理员才能看到活动展示标签
            const activitiesTabEl = document.getElementById('activitiesTabBtn');
            if (activitiesTabEl) {
                activitiesTabEl.style.display = currentUser.role === PERMISSIONS.SUPER_ADMIN ? 'block' : 'none';
            }
        }

        // 获取角色显示名称
        function getRoleDisplayName(role) {
            const roleNames = {
                [PERMISSIONS.USER]: '普通用户',
                [PERMISSIONS.ADMIN]: '管理员',
                [PERMISSIONS.SUPER_ADMIN]: '超级管理员'
            };
            return roleNames[role] || '未知';
        }

        // 权限检查
        function hasPermission(requiredRole) {
            const roleHierarchy = {
                [PERMISSIONS.USER]: 1,
                [PERMISSIONS.ADMIN]: 2,
                [PERMISSIONS.SUPER_ADMIN]: 3
            };

            return roleHierarchy[currentUser.role] >= roleHierarchy[requiredRole];
        }

        // 添加操作日志（保存到数据库）
        async function addLog(action, title, details) {
            const log = {
                action: action,
                title: title,
                details: details,
                user: currentUser.username,
                createdAt: Date.now()
            };

            console.log('添加日志到数据库:', log);

            try {
                // 保存到数据库
                const response = await fetch('api/operation-logs.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(log)
                });

                const data = await response.json();

                if (data.success) {
                    console.log('✅ 日志已保存到数据库');

                    // 如果当前在日志页面，更新显示
                    if (document.getElementById('logsTab') && document.getElementById('logsTab').classList.contains('active')) {
                        await loadLogs();
                        renderLogs();
                    }
                } else {
                    console.error('❌ 保存日志失败:', data.message);
                }
            } catch (error) {
                console.error('❌ 保存日志到数据库失败:', error);
                // 降级到localStorage
                saveLogsLocalStorage(log);
            }
        }

        // 降级方案：保存到localStorage
        function saveLogsLocalStorage(log) {
            try {
                const savedLogs = localStorage.getItem('operationLogs');
                let logs = savedLogs ? JSON.parse(savedLogs) : [];
                logs.unshift(log);
                localStorage.setItem('operationLogs', JSON.stringify(logs));
                console.log('ℹ️ 日志已保存到localStorage（降级方案）');
            } catch (e) {
                console.error('保存到localStorage也失败:', e);
            }
        }

        // 加载日志（从数据库）
        async function loadLogs(filter = 'all') {
            try {
                console.log('从数据库加载日志，过滤:', filter);

                const url = filter === 'all'
                    ? 'api/operation-logs.php?action=all'
                    : `api/operation-logs.php?action=${filter}`;

                const response = await fetch(url);
                const data = await response.json();

                if (data.success && data.data && data.data.logs) {
                    operationLogs = data.data.logs;
                    console.log('✅ 成功从数据库加载日志，总数:', operationLogs.length);
                } else {
                    console.error('❌ 加载日志失败:', data.message);
                    operationLogs = [];
                }
            } catch (error) {
                console.error('❌ 从数据库加载日志失败:', error);
                // 降级到localStorage
                loadLogsFromLocalStorage();
            }
        }

        // 降级方案：从localStorage加载
        function loadLogsFromLocalStorage() {
            try {
                const savedLogs = localStorage.getItem('operationLogs');
                if (savedLogs) {
                    operationLogs = JSON.parse(savedLogs);
                    console.log('ℹ️ 从localStorage加载日志（降级方案），总数:', operationLogs.length);
                } else {
                    operationLogs = [];
                }
            } catch (e) {
                console.error('从localStorage加载失败:', e);
                operationLogs = [];
            }
        }

        // 渲染日志
        function renderLogs(filter = 'all') {
            const logListEl = document.getElementById('logList');
            if (!logListEl) {
                console.error('找不到日志列表元素 logList');
                return;
            }

            console.log('开始渲染日志，当前日志总数:', operationLogs.length);
            console.log('过滤条件:', filter);

            let filteredLogs = operationLogs;
            if (filter !== 'all') {
                filteredLogs = operationLogs.filter(log => log.action === filter);
            }

            console.log('过滤后日志数量:', filteredLogs.length);

            if (filteredLogs.length === 0) {
                logListEl.innerHTML = `
                    <div class="empty-logs">
                        <i class="fas fa-history"></i>
                        <h3>暂无操作记录</h3>
                        <p>系统将自动记录所有操作</p>
                    </div>
                `;
                return;
            }

            logListEl.innerHTML = filteredLogs.map(log => `
                <div class="log-item">
                    <div class="log-icon ${log.action}">
                        <i class="fas fa-${getActionIcon(log.action)}"></i>
                    </div>
                    <div class="log-content">
                        <div class="log-action">${log.title}</div>
                        <div class="log-details">${log.details}</div>
                        <div class="log-time">${log.timestamp}</div>
                    </div>
                    <div class="log-user">${log.user}</div>
                </div>
            `).join('');

            console.log('日志渲染完成');

            // 确保日志页面和列表元素可见
            const logsTab = document.getElementById('logsTab');
            const logViewer = document.querySelector('.log-viewer');

            if (logsTab) {
                logsTab.style.cssText = 'display: block !important;';
                logsTab.classList.add('active');
            }

            if (logViewer) {
                logViewer.style.cssText = `
                    display: block !important;
                    width: 100% !important;
                    min-height: 400px !important;
                    height: auto !important;
                    background: white !important;
                    border-radius: 8px !important;
                    padding: 30px !important;
                    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05) !important;
                    margin-top: 20px !important;
                `;
            }

            // 强制显示日志列表
            logListEl.style.cssText = `
                display: block !important;
                visibility: visible !important;
                opacity: 1 !important;
                height: auto !important;
                min-height: 300px !important;
                max-height: 600px !important;
                width: 100% !important;
                overflow-y: auto !important;
                border: 2px solid #e9ecef !important;
                border-radius: 8px !important;
                background: white !important;
                padding: 20px !important;
                box-sizing: border-box !important;
                position: relative !important;
                z-index: 10 !important;
            `;

            // 检查渲染后的内容
            console.log('渲染后的HTML内容:', logListEl.innerHTML.substring(0, 200) + '...');
            console.log('日志列表元素样式:', {
                display: logListEl.style.display,
                visibility: logListEl.style.visibility,
                opacity: logListEl.style.opacity,
                height: logListEl.offsetHeight,
                width: logListEl.offsetWidth
            });
        }

        // 获取操作图标
        function getActionIcon(action) {
            const icons = {
                'create': 'plus',
                'update': 'edit',
                'delete': 'trash',
                'login': 'sign-in-alt',
                'logout': 'sign-out-alt'
            };
            return icons[action] || 'info';
        }

        // 过滤日志
        function filterLogs(filter) {
            // 更新按钮状态
            document.querySelectorAll('.log-filter').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');

            renderLogs(filter);
        }

        // 清空日志
        async function clearLogs() {
            if (!hasPermission(PERMISSIONS.SUPER_ADMIN)) {
                showNotification('权限不足！只有超级管理员可以清空日志', 'error');
                return;
            }

            if (confirm('确定要清空所有操作日志吗？\n\n此操作不可恢复！')) {
                try {
                    // 1. 先清空数据库
                    const response = await fetch('api/operation-logs.php', {
                        method: 'DELETE',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ clear_all: true })
                    });
                    const data = await response.json();

                    if (!data.success) {
                        showNotification('清空日志失败: ' + (data.message || '未知错误'), 'error');
                        return;
                    }

                    // 2. 清空localStorage
                    operationLogs = [];
                    localStorage.removeItem('operationLogs');
                    localStorage.setItem('operationLogs', JSON.stringify([]));

                    // 3. 重新渲染
                    renderLogs();

                    // 4. 添加日志记录
                    addLog('delete', '清空日志', '超级管理员清空了所有操作日志');

                    showNotification('日志已清空', 'success');
                } catch (error) {
                    console.error('清空日志失败:', error);
                    showNotification('清空日志失败: ' + error.message, 'error');
                }
            }
        }

        // 刷新日志
        function refreshLogs() {
            console.log('手动刷新日志');
            loadLogs(); // 重新从localStorage加载日志
            renderLogs(); // 重新渲染日志
            showNotification('日志已刷新', 'success');
        }

        // ============================================
        // Excel 导出功能
        // ============================================

        // 导出新闻到 Excel
        async function exportNewsToExcel() {
            if (!hasPermission(PERMISSIONS.SUPER_ADMIN)) {
                showNotification('权限不足！只有超级管理员可以导出数据', 'error');
                return;
            }

            try {
                showNotification('正在准备导出数据...', 'info');

                // 获取新闻数据
                let newsData = news;
                if (newsData.length === 0) {
                    showNotification('没有新闻数据可以导出', 'warning');
                    return;
                }

                // 准备Excel数据 - 包含所有新增字段
                const excelData = newsData.map((item, index) => ({
                    '序号': index + 1,
                    '标题': item.title || '',
                    '副标题': item.subtitle || '',
                    '内容': item.content || '',
                    '活动日期': item.date || '',
                    '活动时间': item.time || '',
                    '活动地点': item.location || '',
                    '主办方': item.organizer || '',
                    '联合组织者': item.coOrganizer || '',
                    '核心功能': item.coreFunction || '',
                    '活动亮点': item.highlights || '',
                    '活动目标': item.eventGoal || '',
                    '预期参与人数': item.participants || '',
                    '活动规模': item.eventScale || '',
                    '活动费用': item.eventFee || '',
                    '参与人员列表': (item.participantsList && Array.isArray(item.participantsList))
                        ? item.participantsList.join('\n') : '',
                    '工作人员列表': (item.staffList && Array.isArray(item.staffList))
                        ? item.staffList.join('\n') : '',
                    '新闻分类': item.category || '活动新闻',
                    '创建时间': item.createdAt ? new Date(item.createdAt).toLocaleString('zh-CN') : '',
                    'ID': item.id || ''
                }));

                // 创建工作簿
                const wb = XLSX.utils.book_new();
                const ws = XLSX.utils.json_to_sheet(excelData);

                // 设置列宽
                ws['!cols'] = [
                    { wch: 6 },   // 序号
                    { wch: 30 },  // 标题
                    { wch: 30 },  // 副标题
                    { wch: 50 },  // 内容
                    { wch: 12 },  // 活动日期
                    { wch: 12 },  // 活动时间
                    { wch: 25 },  // 活动地点
                    { wch: 20 },  // 主办方
                    { wch: 20 },  // 联合组织者
                    { wch: 30 },  // 核心功能
                    { wch: 30 },  // 活动亮点
                    { wch: 30 },  // 活动目标
                    { wch: 15 },  // 预期参与人数
                    { wch: 15 },  // 活动规模
                    { wch: 12 },  // 活动费用
                    { wch: 30 },  // 参与人员列表
                    { wch: 30 },  // 工作人员列表
                    { wch: 12 },  // 新闻分类
                    { wch: 20 },  // 创建时间
                    { wch: 10 }   // ID
                ];

                // 添加工作表到工作簿
                XLSX.utils.book_append_sheet(wb, ws, '活动新闻');

                // 生成文件名
                const timestamp = new Date().toLocaleString('zh-CN', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit'
                }).replace(/\//g, '-').replace(/:/g, '-').replace(/\s/g, '_');
                const filename = `新闻数据_${timestamp}.xlsx`;

                // 导出文件
                XLSX.writeFile(wb, filename);

                // 记录日志
                await addLog('export', '导出新闻数据', `导出了 ${newsData.length} 条新闻到 Excel 文件: ${filename}`);

                showNotification(`✅ 成功导出 ${newsData.length} 条新闻！`, 'success');

            } catch (error) {
                console.error('导出新闻失败:', error);
                showNotification('❌ 导出失败: ' + error.message, 'error');
            }
        }

        // 导出文章到 Excel
        async function exportArticlesToExcel() {
            if (!hasPermission(PERMISSIONS.SUPER_ADMIN)) {
                showNotification('权限不足！只有超级管理员可以导出数据', 'error');
                return;
            }

            try {
                showNotification('正在准备导出数据...', 'info');

                // 获取文章数据
                let articlesData = articles;
                if (articlesData.length === 0) {
                    showNotification('没有文章数据可以导出', 'warning');
                    return;
                }

                // 准备Excel数据
                const excelData = articlesData.map((item, index) => ({
                    '序号': index + 1,
                    '标题': item.title || '',
                    '内容': item.content || '',
                    '链接': item.link || '',
                    '分类': item.category || '',
                    '发布日期': item.date || '',
                    '作者': item.author || '东方美谷韩国中心',
                    '创建时间': item.createdAt ? new Date(item.createdAt).toLocaleString('zh-CN') : '',
                    'ID': item.id || ''
                }));

                // 创建工作簿
                const wb = XLSX.utils.book_new();
                const ws = XLSX.utils.json_to_sheet(excelData);

                // 设置列宽
                ws['!cols'] = [
                    { wch: 6 },  // 序号
                    { wch: 30 }, // 标题
                    { wch: 50 }, // 内容
                    { wch: 40 }, // 链接
                    { wch: 12 }, // 分类
                    { wch: 12 }, // 发布日期
                    { wch: 20 }, // 作者
                    { wch: 20 }, // 创建时间
                    { wch: 10 }  // ID
                ];

                // 添加工作表到工作簿
                XLSX.utils.book_append_sheet(wb, ws, '公众号文章');

                // 生成文件名
                const timestamp = new Date().toLocaleString('zh-CN', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit'
                }).replace(/\//g, '-').replace(/:/g, '-').replace(/\s/g, '_');
                const filename = `文章数据_${timestamp}.xlsx`;

                // 导出文件
                XLSX.writeFile(wb, filename);

                // 记录日志
                await addLog('export', '导出文章数据', `导出了 ${articlesData.length} 篇文章到 Excel 文件: ${filename}`);

                showNotification(`✅ 成功导出 ${articlesData.length} 篇文章！`, 'success');

            } catch (error) {
                console.error('导出文章失败:', error);
                showNotification('❌ 导出失败: ' + error.message, 'error');
            }
        }

        // 导出所有数据
        async function exportAllData() {
            if (!hasPermission(PERMISSIONS.SUPER_ADMIN)) {
                showNotification('权限不足！只有超级管理员可以导出数据', 'error');
                return;
            }

            try {
                showNotification('正在准备导出所有数据...', 'info');

                // 创建工作簿
                const wb = XLSX.utils.book_new();

                // 1. 导出新闻
                if (news.length > 0) {
                    const newsData = news.map((item, index) => ({
                        '序号': index + 1,
                        '标题': item.title || '',
                        '内容': item.content || '',
                        '日期': item.date || '',
                        '时间': item.time || '',
                        '地点': item.location || '',
                        '主办方': item.organizer || '',
                        '联合组织者': item.coOrganizer || '',
                        '核心功能': item.coreFunction || '',
                        '亮点': item.highlights || '',
                        '分类': item.category || '活动新闻',
                        '创建时间': item.createdAt ? new Date(item.createdAt).toLocaleString('zh-CN') : '',
                        'ID': item.id || ''
                    }));
                    const wsNews = XLSX.utils.json_to_sheet(newsData);
                    wsNews['!cols'] = [
                        { wch: 6 }, { wch: 30 }, { wch: 50 }, { wch: 12 }, { wch: 10 },
                        { wch: 20 }, { wch: 20 }, { wch: 20 }, { wch: 20 }, { wch: 30 },
                        { wch: 12 }, { wch: 20 }, { wch: 10 }
                    ];
                    XLSX.utils.book_append_sheet(wb, wsNews, '活动新闻');
                }

                // 2. 导出文章
                if (articles.length > 0) {
                    const articlesData = articles.map((item, index) => ({
                        '序号': index + 1,
                        '标题': item.title || '',
                        '内容': item.content || '',
                        '链接': item.link || '',
                        '分类': item.category || '',
                        '发布日期': item.date || '',
                        '作者': item.author || '东方美谷韩国中心',
                        '创建时间': item.createdAt ? new Date(item.createdAt).toLocaleString('zh-CN') : '',
                        'ID': item.id || ''
                    }));
                    const wsArticles = XLSX.utils.json_to_sheet(articlesData);
                    wsArticles['!cols'] = [
                        { wch: 6 }, { wch: 30 }, { wch: 50 }, { wch: 40 },
                        { wch: 12 }, { wch: 12 }, { wch: 20 }, { wch: 20 }, { wch: 10 }
                    ];
                    XLSX.utils.book_append_sheet(wb, wsArticles, '公众号文章');
                }

                // 3. 导出统计信息
                const statsData = [
                    { '项目': '新闻总数', '数量': news.length },
                    { '项目': '文章总数', '数量': articles.length },
                    { '项目': '导出时间', '数量': new Date().toLocaleString('zh-CN') },
                    { '项目': '导出用户', '数量': currentUser.username }
                ];
                const wsStats = XLSX.utils.json_to_sheet(statsData);
                wsStats['!cols'] = [{ wch: 20 }, { wch: 40 }];
                XLSX.utils.book_append_sheet(wb, wsStats, '统计信息');

                // 生成文件名
                const timestamp = new Date().toLocaleString('zh-CN', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit'
                }).replace(/\//g, '-').replace(/:/g, '-').replace(/\s/g, '_');
                const filename = `全部数据_${timestamp}.xlsx`;

                // 导出文件
                XLSX.writeFile(wb, filename);

                // 记录日志
                await addLog('export', '导出所有数据', `导出了 ${news.length} 条新闻和 ${articles.length} 篇文章到 Excel 文件: ${filename}`);

                showNotification(`✅ 成功导出所有数据！\n新闻: ${news.length} 条\n文章: ${articles.length} 篇`, 'success');

            } catch (error) {
                console.error('导出所有数据失败:', error);
                showNotification('❌ 导出失败: ' + error.message, 'error');
            }
        }

        // 调试函数 - 检查日志系统状态
        function debugLogs() {
            console.log('=== 日志系统调试信息 ===');
            console.log('当前用户:', currentUser);
            console.log('当前日志数组:', operationLogs);
            console.log('localStorage中的日志:', localStorage.getItem('operationLogs'));
            console.log('日志总数:', operationLogs.length);

            // 添加测试日志
            addLog('create', '测试日志', '这是一条测试日志，用于验证系统是否正常工作');
            console.log('添加测试日志后，日志总数:', operationLogs.length);
        }

        // 强制显示日志 - 调试用
        function forceShowLogs() {
            const logListEl = document.getElementById('logList');
            const logViewer = document.querySelector('.log-viewer');
            const logsTab = document.getElementById('logsTab');

            if (!logListEl) {
                console.error('找不到日志列表元素');
                return;
            }

            // 强制设置日志页面样式
            if (logsTab) {
                logsTab.style.cssText = `
                    display: block !important;
                    background: white !important;
                    border-radius: 8px !important;
                    padding: 30px !important;
                    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05) !important;
                `;
            }

            // 强制设置日志查看器样式
            if (logViewer) {
                logViewer.style.cssText = `
                    display: block !important;
                    width: 100% !important;
                    min-height: 400px !important;
                    height: auto !important;
                    background: white !important;
                    border-radius: 8px !important;
                    padding: 30px !important;
                    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05) !important;
                    margin-top: 20px !important;
                `;
            }

            // 清除所有可能的隐藏样式
            logListEl.style.cssText = `
                display: block !important;
                visibility: visible !important;
                opacity: 1 !important;
                height: auto !important;
                min-height: 300px !important;
                max-height: 600px !important;
                width: 100% !important;
                overflow-y: auto !important;
                border: 2px solid #e9ecef !important;
                border-radius: 8px !important;
                background: white !important;
                padding: 20px !important;
                box-sizing: border-box !important;
                position: relative !important;
                z-index: 10 !important;
            `;

            // 直接设置内容
            logListEl.innerHTML = operationLogs.map(log => `
                <div style="padding: 15px 20px; border-bottom: 1px solid #f0f0f0; display: flex; align-items: center; gap: 15px;">
                    <div style="width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; color: white; background: ${log.action === 'create' ? '#28a745' : log.action === 'update' ? '#ffc107' : log.action === 'delete' ? '#dc3545' : '#17a2b8'};">
                        <i class="fas fa-${getActionIcon(log.action)}"></i>
                    </div>
                    <div style="flex: 1;">
                        <div style="font-weight: 600; color: #333; margin-bottom: 4px;">${log.title}</div>
                        <div style="font-size: 0.9rem; color: #666; margin-bottom: 2px;">${log.details}</div>
                        <div style="font-size: 0.8rem; color: #999;">${log.timestamp}</div>
                    </div>
                    <div style="font-size: 0.85rem; color: #667eea; font-weight: 500;">${log.user}</div>
                </div>
            `).join('');

            console.log('强制显示日志完成，内容长度:', logListEl.innerHTML.length);
            console.log('修复后元素尺寸:', {
                logsTab: logsTab ? { height: logsTab.offsetHeight, width: logsTab.offsetWidth } : 'null',
                logViewer: logViewer ? { height: logViewer.offsetHeight, width: logViewer.offsetWidth } : 'null',
                logList: { height: logListEl.offsetHeight, width: logListEl.offsetWidth }
            });
        }

        // 简单测试函数 - 直接在页面上显示日志
        function testLogs() {
            const logListEl = document.getElementById('logList');
            if (!logListEl) {
                console.error('找不到日志列表元素');
                return;
            }

            // 直接设置简单的测试内容
            logListEl.innerHTML = `
                <div style="padding: 20px; background: #f0f0f0; border: 2px solid #333; margin: 10px;">
                    <h3 style="color: #333;">测试日志显示</h3>
                    <p style="color: #666;">如果你能看到这个内容，说明日志列表元素是可见的</p>
                    <p style="color: #666;">当前日志数量: ${operationLogs.length}</p>
                </div>
            `;

            // 强制设置样式
            logListEl.style.cssText = `
                display: block !important;
                visibility: visible !important;
                opacity: 1 !important;
                height: auto !important;
                min-height: 200px !important;
                width: 100% !important;
                background: white !important;
                border: 2px solid red !important;
                padding: 20px !important;
            `;

            console.log('测试内容已设置，请检查页面是否显示红色边框的测试内容');
        }

        // 强制设置日志列表尺寸
        function forceLogListSize() {
            const logListEl = document.getElementById('logList');
            if (!logListEl) {
                console.error('日志列表元素未找到');
                return;
            }

            console.log('强制设置日志列表尺寸...');

            // 使用更强制的方式设置样式
            logListEl.style.setProperty('display', 'block', 'important');
            logListEl.style.setProperty('visibility', 'visible', 'important');
            logListEl.style.setProperty('opacity', '1', 'important');
            logListEl.style.setProperty('height', 'auto', 'important');
            logListEl.style.setProperty('min-height', '300px', 'important');
            logListEl.style.setProperty('max-height', '600px', 'important');
            logListEl.style.setProperty('width', '100%', 'important');
            logListEl.style.setProperty('overflow-y', 'auto', 'important');
            logListEl.style.setProperty('border', '2px solid #e9ecef', 'important');
            logListEl.style.setProperty('border-radius', '8px', 'important');
            logListEl.style.setProperty('background', 'white', 'important');
            logListEl.style.setProperty('padding', '20px', 'important');
            logListEl.style.setProperty('box-sizing', 'border-box', 'important');
            logListEl.style.setProperty('position', 'relative', 'important');
            logListEl.style.setProperty('z-index', '10', 'important');

            // 检查设置后的状态
            const computedStyle = window.getComputedStyle(logListEl);
            console.log('强制设置后的样式:', {
                display: computedStyle.display,
                height: computedStyle.height,
                width: computedStyle.width,
                minHeight: computedStyle.minHeight,
                maxHeight: computedStyle.maxHeight
            });

            // 如果还是没有高度，尝试设置固定高度
            if (computedStyle.height === '0px' || computedStyle.height === 'auto') {
                logListEl.style.setProperty('height', '400px', 'important');
                console.log('设置固定高度 400px');
            }
        }

        // 简单直接的日志显示测试
        function showLogsDirectly() {
            console.log('=== 直接显示日志测试 ===');

            // 1. 检查当前用户
            console.log('当前用户:', currentUser);
            if (!currentUser || currentUser.role !== 'super-admin') {
                console.error('需要超级管理员权限才能查看日志');
                return;
            }

            // 2. 检查日志数据
            console.log('操作日志数量:', operationLogs.length);
            console.log('操作日志内容:', operationLogs);

            // 3. 直接显示日志
            const logListEl = document.getElementById('logList');
            if (!logListEl) {
                console.error('找不到日志列表元素');
                return;
            }

            // 4. 强制显示日志页面
            const logsTab = document.getElementById('logsTab');
            if (logsTab) {
                logsTab.style.cssText = 'display: block !important;';
                console.log('日志页面已显示');
            }

            // 5. 强制设置日志列表样式
            logListEl.style.cssText = `
                display: block !important;
                visibility: visible !important;
                opacity: 1 !important;
                height: 400px !important;
                width: 100% !important;
                background: white !important;
                border: 2px solid #007bff !important;
                border-radius: 8px !important;
                padding: 20px !important;
                overflow-y: auto !important;
                box-sizing: border-box !important;
            `;

            // 6. 直接设置内容
            if (operationLogs.length === 0) {
                logListEl.innerHTML = `
                    <div style="text-align: center; padding: 50px; color: #666;">
                        <i class="fas fa-info-circle" style="font-size: 3rem; margin-bottom: 20px;"></i>
                        <h3>暂无操作日志</h3>
                        <p>还没有任何操作记录</p>
                    </div>
                `;
            } else {
                logListEl.innerHTML = operationLogs.map(log => `
                    <div style="padding: 15px; border-bottom: 1px solid #eee; display: flex; align-items: center; gap: 15px;">
                        <div style="width: 40px; height: 40px; border-radius: 50%; background: #007bff; color: white; display: flex; align-items: center; justify-content: center;">
                            <i class="fas fa-${log.action === 'create' ? 'plus' : log.action === 'update' ? 'edit' : log.action === 'delete' ? 'trash' : 'info'}"></i>
                        </div>
                        <div style="flex: 1;">
                            <div style="font-weight: bold; color: #333;">${log.title}</div>
                            <div style="color: #666; font-size: 0.9rem;">${log.details}</div>
                            <div style="color: #999; font-size: 0.8rem; margin-top: 5px;">
                                ${log.user} • ${log.timestamp}
                            </div>
                        </div>
                    </div>
                `).join('');
            }

            console.log('日志内容已直接设置');
            console.log('日志列表元素状态:', {
                display: logListEl.style.display,
                height: logListEl.style.height,
                width: logListEl.style.width,
                innerHTML: logListEl.innerHTML.substring(0, 100) + '...'
            });
        }

        // 深度诊断函数 - 检查所有可能的问题
        function diagnoseLogs() {
            const logListEl = document.getElementById('logList');
            const logViewer = document.querySelector('.log-viewer');
            const logsTab = document.getElementById('logsTab');

            console.log('=== 深度诊断开始 ===');

            // 1. 检查元素是否存在
            console.log('1. 元素存在性检查:');
            console.log('  - logListEl:', logListEl ? '存在' : '不存在');
            console.log('  - logViewer:', logViewer ? '存在' : '不存在');
            console.log('  - logsTab:', logsTab ? '存在' : '不存在');

            if (!logListEl) {
                console.error('日志列表元素不存在！');
                return;
            }

            // 2. 检查元素位置和尺寸
            console.log('2. 元素位置和尺寸:');
            const rect = logListEl.getBoundingClientRect();
            console.log('  - 位置:', {
                top: rect.top,
                left: rect.left,
                bottom: rect.bottom,
                right: rect.right,
                width: rect.width,
                height: rect.height
            });
            console.log('  - 是否在视口内:', rect.top >= 0 && rect.left >= 0 && rect.bottom <= window.innerHeight && rect.right <= window.innerWidth);

            // 3. 检查计算样式
            console.log('3. 计算样式检查:');
            const computedStyle = window.getComputedStyle(logListEl);
            console.log('  - display:', computedStyle.display);
            console.log('  - visibility:', computedStyle.visibility);
            console.log('  - opacity:', computedStyle.opacity);
            console.log('  - position:', computedStyle.position);
            console.log('  - z-index:', computedStyle.zIndex);
            console.log('  - overflow:', computedStyle.overflow);

            // 4. 检查父元素
            console.log('4. 父元素检查:');
            let parent = logListEl.parentElement;
            let level = 0;
            while (parent && level < 5) {
                const parentRect = parent.getBoundingClientRect();
                const parentStyle = window.getComputedStyle(parent);
                console.log(`  - 父元素 ${level}:`, {
                    tagName: parent.tagName,
                    className: parent.className,
                    id: parent.id,
                    display: parentStyle.display,
                    visibility: parentStyle.visibility,
                    opacity: parentStyle.opacity,
                    overflow: parentStyle.overflow,
                    position: parentStyle.position,
                    zIndex: parentStyle.zIndex,
                    size: { width: parentRect.width, height: parentRect.height }
                });
                parent = parent.parentElement;
                level++;
            }

            // 5. 检查是否有其他元素遮挡
            console.log('5. 遮挡检查:');
            const elementsAtPoint = document.elementsFromPoint(rect.left + rect.width / 2, rect.top + rect.height / 2);
            console.log('  - 该位置的元素:', elementsAtPoint.map(el => ({
                tagName: el.tagName,
                className: el.className,
                id: el.id
            })));

            // 6. 强制显示并检查
            console.log('6. 强制显示测试:');
            logListEl.style.cssText = `
                position: fixed !important;
                top: 50% !important;
                left: 50% !important;
                transform: translate(-50%, -50%) !important;
                z-index: 99999 !important;
                display: block !important;
                visibility: visible !important;
                opacity: 1 !important;
                width: 400px !important;
                height: 300px !important;
                background: red !important;
                border: 5px solid yellow !important;
                padding: 20px !important;
                color: white !important;
                font-size: 20px !important;
            `;

            logListEl.innerHTML = `
                <div style="text-align: center;">
                    <h1 style="color: white; margin-bottom: 20px;">强制显示测试</h1>
                    <p style="color: white; font-size: 16px;">如果你能看到这个红色背景、黄色边框的内容，说明元素可以显示</p>
                    <p style="color: white; font-size: 16px;">日志数量: ${operationLogs.length}</p>
                </div>
            `;

            console.log('强制显示设置完成，请检查页面中央是否出现红色背景的测试内容');
        }

        // 快速修复函数 - 强制显示日志页面
        function fixLogsDisplay() {
            const logsTab = document.getElementById('logsTab');
            const logViewer = document.querySelector('.log-viewer');
            const logList = document.getElementById('logList');

            if (logsTab) {
                logsTab.style.cssText = 'display: block !important;';
                logsTab.classList.add('active');
            }

            if (logViewer) {
                logViewer.style.cssText = `
                    display: block !important;
                    width: 100% !important;
                    min-height: 400px !important;
                    height: auto !important;
                    background: white !important;
                    border-radius: 8px !important;
                    padding: 30px !important;
                    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05) !important;
                    margin-top: 20px !important;
                `;
            }

            if (logList) {
                logList.style.cssText = `
                    display: block !important;
                    visibility: visible !important;
                    opacity: 1 !important;
                    height: auto !important;
                    min-height: 300px !important;
                    max-height: 600px !important;
                    width: 100% !important;
                    overflow-y: auto !important;
                    border: 2px solid #e9ecef !important;
                    border-radius: 8px !important;
                    background: white !important;
                    padding: 20px !important;
                    box-sizing: border-box !important;
                    position: relative !important;
                    z-index: 10 !important;
                `;
            }

            // 重新渲染日志
            renderLogs();
            console.log('日志显示已修复');
        }

        // 将调试函数暴露到全局作用域
        window.debugLogs = debugLogs;
        window.refreshLogs = refreshLogs;
        window.forceShowLogs = forceShowLogs;
        window.testLogs = testLogs;
        window.diagnoseLogs = diagnoseLogs;
        window.fixLogsDisplay = fixLogsDisplay;

        // 跳转到首页
        function goToHome() {
            if (confirm('确定要返回首页吗？\n\n当前未保存的更改将会丢失')) {
                window.location.href = 'index.html';
            }
        }

        // 从API加载数据
        async function loadData() {
            try {
                const response = await fetch('api/get-data.php?type=all');
                const result = await response.json();

                if (result.success && result.data) {
                    articles = result.data.articles || [];
                    news = result.data.news || [];

                    console.log('✅ 数据加载成功:', {
                        articles: articles.length,
                        news: news.length
                    });

                    // 注意：不保存完整数据到localStorage（图片数据太大）
                    // 只保存基本信息，避免QuotaExceededError
                    try {
                        // 只保存不带图片的数据副本
                        const articlesWithoutImages = articles.map(a => ({
                            id: a.id,
                            title: a.title,
                            category: a.category,
                            date: a.date,
                            author: a.author
                        }));
                        localStorage.setItem('articles_meta', JSON.stringify(articlesWithoutImages));

                        const newsWithoutImages = news.map(n => ({
                            id: n.id,
                            title: n.title,
                            category: n.category,
                            date: n.date
                        }));
                        localStorage.setItem('news_meta', JSON.stringify(newsWithoutImages));

                        localStorage.setItem('lastLoadTime', Date.now().toString());
                        console.log('✅ 已保存元数据到localStorage');
                    } catch (e) {
                        console.warn('⚠️ 无法保存元数据（不影响显示）:', e.message);
                    }
                } else {
                    console.error('API加载失败:', result.message);
                    // 尝试从localStorage加载元数据（通常为空）
                    articles = JSON.parse(localStorage.getItem('articles') || '[]');
                    news = JSON.parse(localStorage.getItem('news') || '[]');
                }
            } catch (error) {
                console.error('❌ 加载数据失败:', error);

                // 如果是存储空间问题，直接使用内存中的数据
                if (error.name === 'QuotaExceededError') {
                    console.warn('⚠️ localStorage空间不足，使用API数据直接显示');
                    // 数据已经在上面加载到内存中了，直接使用
                } else {
                    // 其他错误，尝试从localStorage加载
                    articles = JSON.parse(localStorage.getItem('articles') || '[]');
                    news = JSON.parse(localStorage.getItem('news') || '[]');
                }
            }

            // 更新显示
            updateArticlesDisplay();
            updateNewsDisplay();
            updateStats();
        }

        // 保存数据到localStorage（不保存完整数据，只保存更新信号）
        function saveData() {
            try {
                // 不保存完整数据（因为图片数据太大），只保存时间戳
                const updateInfo = {
                    lastUpdated: new Date().toISOString(),
                    articlesCount: articles.length,
                    newsCount: news.length
                };
                localStorage.setItem('updateInfo', JSON.stringify(updateInfo));

                // 触发storage事件，通知其他页面需要刷新数据
                window.dispatchEvent(new StorageEvent('storage', {
                    key: 'updateInfo',
                    newValue: JSON.stringify(updateInfo)
                }));

                // 触发自定义事件，通知同一标签页内的其他页面更新
                window.dispatchEvent(new CustomEvent('storageUpdate', {
                    detail: {
                        key: 'updateInfo',
                        newValue: JSON.stringify(updateInfo)
                    }
                }));

                console.log('✅ 数据更新时间已记录:', updateInfo);
            } catch (e) {
                console.warn('⚠️ 无法保存更新信息（不影响操作）:', e.message);
                // 即使保存失败，也触发事件通知其他页面刷新
                window.dispatchEvent(new CustomEvent('storageUpdate', {
                    detail: {
                        key: 'forceRefresh',
                        newValue: Date.now().toString()
                    }
                }));
            }
        }

        // 更新文章显示
        function updateArticlesDisplay() {
            const articlesList = document.getElementById('articlesList');

            if (articles.length === 0) {
                articlesList.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-file-alt"></i>
                        <h3>暂无文章</h3>
                        <p>点击"添加文章"开始创建内容</p>
                    </div>
                `;
                return;
            }

            // 按日期排序（最新的在前）
            const sortedArticles = articles.sort((a, b) => new Date(b.date) - new Date(a.date));

            articlesList.innerHTML = sortedArticles.map((article, index) => `
                <div class="article-link-item admin-article-item">
                    <div class="article-link-content">
                        <div class="article-link-meta">
                            <span class="article-link-category">${article.category}</span>
                            <span class="article-link-date">${article.date}</span>
                        </div>
                        <h3 class="article-link-title">${article.title}</h3>
                        <p class="article-link-desc">${article.content}</p>
                        <div class="article-link-actions">
                            <button class="action-btn edit-btn" onclick="editArticle(${index})">
                                <i class="fas fa-edit"></i> 编辑
                            </button>
                            <button class="action-btn delete-btn" onclick="deleteArticle(${index})">
                                <i class="fas fa-trash"></i> 删除
                            </button>
                            <a href="${article.link}" target="_blank" class="action-btn view-btn">
                                <i class="fas fa-external-link-alt"></i> 查看
                            </a>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // 更新新闻显示
        function updateNewsDisplay() {
            const newsList = document.getElementById('newsList');

            if (news.length === 0) {
                newsList.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-newspaper"></i>
                        <h3>暂无新闻</h3>
                        <p>点击"添加新闻"开始创建内容</p>
                    </div>
                `;
                return;
            }

            // 按日期排序（最新的在前）
            const sortedNews = news.sort((a, b) => new Date(b.date) - new Date(a.date));

            newsList.innerHTML = sortedNews.map((newsItem, index) => {
                // 优先使用封面图
                let coverImage = '';
                if (newsItem.coverImage) {
                    coverImage = newsItem.coverImage;
                    console.log(`[新闻${index}] 使用 coverImage 字段，长度: ${coverImage.length}`);
                } else if (newsItem.cover_image) {
                    coverImage = newsItem.cover_image;
                    console.log(`[新闻${index}] 使用 cover_image 字段，长度: ${coverImage.length}`);
                } else {
                    console.log(`[新闻${index}] 无封面图`);
                }

                // 生成封面图容器（占位，稍后通过JS填充）
                const coverImageHtml = coverImage ? `
                    <div class="news-cover-preview" data-cover="${index}" style="width: 100px; height: 100px; overflow: hidden; border-radius: 8px; margin-right: 15px; flex-shrink: 0; background: #f0f0f0; display: flex; align-items: center; justify-content: center;">
                        <div style="color: #999; font-size: 0.8rem;">加载中...</div>
                    </div>
                ` : '';

                return `
                <div class="article-link-item admin-article-item">
                    <div class="article-link-content" style="display: flex; align-items: flex-start;">
                        ${coverImageHtml}
                        <div style="flex: 1;">
                            <div class="article-link-meta">
                                <span class="article-link-category">${newsItem.category || '新闻'}</span>
                                <span class="article-link-date">${newsItem.date} ${newsItem.time ? newsItem.time : ''}</span>
                            </div>
                            <h3 class="article-link-title">${newsItem.title}</h3>
                            <p class="article-link-desc">${newsItem.content}</p>
                        <div class="news-details">
                            <div class="news-detail-item">
                                <strong>主办方：</strong>${newsItem.organizer || ''}
                            </div>
                            <div class="news-detail-item">
                                <strong>地点：</strong>${newsItem.location || ''}
                            </div>
                            ${newsItem.coOrganizer ? `
                            <div class="news-detail-item">
                                <strong>联合组织者：</strong>${newsItem.coOrganizer}
                            </div>
                            ` : ''}
                            <div class="news-detail-item">
                                <strong>核心功能：</strong>${newsItem.coreFunction || ''}
                            </div>
                            <div class="news-detail-item">
                                <strong>亮点活动：</strong>${newsItem.highlights || ''}
                            </div>
                            </div>
                            <div class="article-link-actions">
                                <button class="action-btn edit-btn" onclick="editNews(${index})">
                                    <i class="fas fa-edit"></i> 编辑
                                </button>
                                <button class="action-btn delete-btn" onclick="deleteNews(${index})">
                                    <i class="fas fa-trash"></i> 删除
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            }).join('');

            // 动态填充封面图 - 使用Blob URL避免base64字符串过长问题
            requestAnimationFrame(() => {
                sortedNews.forEach((newsItem, idx) => {
                    const preview = document.querySelector(`.news-cover-preview[data-cover="${idx}"]`);
                    if (preview) {
                        const coverImage = newsItem.coverImage || newsItem.cover_image || '';
                        if (coverImage && coverImage.trim() !== '') {
                            try {
                                // 方法1: 尝试直接使用
                                const img = document.createElement('img');
                                img.alt = '封面';
                                img.style.cssText = 'width: 100%; height: 100%; object-fit: cover;';

                                // 设置加载回调
                                let loaded = false;
                                img.onload = function () {
                                    loaded = true;
                                    console.log(`[新闻${idx}] 封面图加载成功`);
                                };

                                img.onerror = function () {
                                    if (!loaded) {
                                        console.warn(`[新闻${idx}] 直接加载失败，尝试简化显示`);
                                        this.parentElement.innerHTML = '<div style="color: #999; font-size: 0.8rem;">封面</div>';
                                        this.parentElement.style.display = 'flex';
                                        this.parentElement.style.alignItems = 'center';
                                        this.parentElement.style.justifyContent = 'center';
                                    }
                                };

                                // 验证base64格式
                                let finalSrc = coverImage;
                                if (!coverImage.startsWith('data:')) {
                                    finalSrc = 'data:image/png;base64,' + coverImage;
                                }

                                img.src = finalSrc;
                                preview.innerHTML = '';
                                preview.appendChild(img);
                            } catch (e) {
                                console.error(`[新闻${idx}] 封面图处理异常:`, e);
                                preview.innerHTML = '';
                                preview.style.display = 'none';
                            }
                        } else {
                            preview.style.display = 'none';
                        }
                    }
                });
            });
        }

        // 更新统计信息
        function updateStats() {
            document.getElementById('articleCount').textContent = articles.length;
            document.getElementById('newsCount').textContent = news.length;
        }

        // 打开文章模态框
        function openArticleModal(articleIndex = null) {
            currentEditingArticle = articleIndex;
            const modal = document.getElementById('articleModal');
            const title = document.getElementById('articleModalTitle');

            if (articleIndex !== null) {
                title.textContent = '编辑文章';
                const article = articles[articleIndex];
                document.getElementById('articleTitle').value = article.title;
                document.getElementById('articleContent').value = article.content;
                document.getElementById('articleLink').value = article.link;
                document.getElementById('articleCategory').value = article.category;
                document.getElementById('articleDate').value = article.date;
            } else {
                title.textContent = '添加文章';
                document.getElementById('articleForm').reset();
                setDefaultDate();
            }

            modal.classList.add('active');
        }

        // 打开新闻模态框
        function openNewsModal(newsIndex = null) {
            currentEditingNews = newsIndex;
            const modal = document.getElementById('newsModal');
            const title = document.getElementById('newsModalTitle');

            if (newsIndex !== null) {
                title.textContent = '编辑新闻';
                const newsItem = news[newsIndex];

                // 填充所有字段
                document.getElementById('newsTitle').value = newsItem.title || '';
                document.getElementById('newsSubtitle').value = newsItem.subtitle || '';
                document.getElementById('newsContent').value = newsItem.content || '';
                document.getElementById('newsDate').value = newsItem.date || '';
                document.getElementById('newsTime').value = newsItem.time || '';
                document.getElementById('newsLocation').value = newsItem.location || '';
                document.getElementById('newsOrganizer').value = newsItem.organizer || '';
                document.getElementById('newsCoOrganizer').value = newsItem.coOrganizer || '';
                document.getElementById('newsCoreFunction').value = newsItem.coreFunction || '';
                document.getElementById('newsHighlights').value = newsItem.highlights || '';
                document.getElementById('newsEventGoal').value = newsItem.eventGoal || '';
                document.getElementById('newsParticipants').value = newsItem.participants || '';
                document.getElementById('newsEventScale').value = newsItem.eventScale || '';
                document.getElementById('newsEventFee').value = newsItem.eventFee || '';
                document.getElementById('newsCategory').value = newsItem.category || '活动新闻';

                // 填充参与人员和工作人员（如果是数组，转换为换行分隔的文本）
                const participantsText = Array.isArray(newsItem.participantsList)
                    ? newsItem.participantsList.join('\n')
                    : (newsItem.participants || '');
                document.getElementById('newsParticipantsList').value = participantsText;

                const staffText = Array.isArray(newsItem.staffList)
                    ? newsItem.staffList.join('\n')
                    : (newsItem.staff || '');
                document.getElementById('newsStaffList').value = staffText;

                // 清空图片和视频预览（因为需要重新上传）
                document.getElementById('newsCoverImagePreview').innerHTML = '';
                document.getElementById('newsImagePreview').innerHTML = '';
                document.getElementById('newsVideoPreview').innerHTML = '';
                document.getElementById('newsCoverImage').value = '';
                document.getElementById('newsImage').value = '';
                document.getElementById('newsVideo').value = '';

            } else {
                title.textContent = '添加新闻';
                document.getElementById('newsForm').reset();
                setDefaultDate();
            }

            modal.classList.add('active');
        }

        // 关闭模态框
        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
            currentEditingArticle = null;
            currentEditingNews = null;
        }

        // 保存文章
        async function saveArticle() {
            const form = document.getElementById('articleForm');
            const formData = new FormData(form);
            const articleData = Object.fromEntries(formData);

            // 验证表单
            if (!articleData.title || !articleData.content || !articleData.link || !articleData.category || !articleData.date) {
                showNotification('请填写所有必填字段！', 'error');
                return;
            }

            // 验证URL格式
            try {
                new URL(articleData.link);
            } catch {
                showNotification('请输入有效的链接地址！', 'error');
                return;
            }

            try {
                let response, result;

                if (currentEditingArticle !== null) {
                    // 编辑模式 - 调用API更新
                    const article = articles[currentEditingArticle];
                    const updateData = {
                        title: articleData.title,
                        content: articleData.content,
                        link: articleData.link,
                        category: articleData.category,
                        publish_date: articleData.date,
                        author: articleData.author || '东方美谷韩国中心'
                    };

                    response = await fetch(`api/manage-data.php?type=articles&id=${article.id}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(updateData)
                    });
                    result = await response.json();

                    if (result.success) {
                        // 更新本地数据
                        articles[currentEditingArticle] = { ...article, ...articleData };
                        addLog('update', '编辑文章', `编辑文章: "${articleData.title}" (分类: ${articleData.category})`);
                        showNotification('文章更新成功！', 'success');
                    } else {
                        throw new Error(result.message || '更新失败');
                    }
                } else {
                    // 添加模式 - 调用API创建
                    const newData = {
                        title: articleData.title,
                        content: articleData.content,
                        link: articleData.link,
                        category: articleData.category,
                        publish_date: articleData.date,
                        author: articleData.author || '东方美谷韩国中心'
                    };

                    response = await fetch('api/manage-data.php?type=articles', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(newData)
                    });
                    result = await response.json();

                    if (result.success) {
                        const newArticle = {
                            id: result.data.id,
                            ...articleData,
                            createdAt: Date.now()
                        };
                        articles.push(newArticle);
                        addLog('create', '添加文章', `添加文章: "${articleData.title}" (分类: ${articleData.category})`);
                        showNotification('文章添加成功！', 'success');
                    } else {
                        throw new Error(result.message || '添加失败');
                    }
                }

                // 重新加载数据
                await loadData();
                updateArticlesDisplay();
                updateStats();
                closeModal('articleModal');

            } catch (error) {
                console.error('保存文章失败:', error);
                showNotification('保存文章失败: ' + error.message, 'error');
            }
        }

        // 多图片预览函数
        function previewImages(input, previewId) {
            const preview = document.getElementById(previewId);
            const files = Array.from(input.files);

            if (files.length > 0) {
                preview.innerHTML = ''; // 清空之前的预览
                files.forEach(file => {
                    const reader = new FileReader();
                    reader.onload = function (e) {
                        const imgDiv = document.createElement('div');
                        imgDiv.style.cssText = 'position: relative; aspect-ratio: 1; overflow: hidden; border-radius: 8px;';
                        imgDiv.innerHTML = `<img src="${e.target.result}" alt="预览" style="width: 100%; height: 100%; object-fit: cover;">`;
                        preview.appendChild(imgDiv);
                    };
                    reader.readAsDataURL(file);
                });
                preview.classList.add('show');
            } else {
                preview.classList.remove('show');
                preview.innerHTML = '';
            }
        }

        // 多视频预览函数
        function previewVideos(input, previewId) {
            const preview = document.getElementById(previewId);
            const files = Array.from(input.files);

            if (files.length > 0) {
                preview.innerHTML = ''; // 清空之前的预览
                files.forEach((file, index) => {
                    const reader = new FileReader();
                    reader.onload = function (e) {
                        const videoDiv = document.createElement('div');
                        videoDiv.style.cssText = 'position: relative; background: #000; border-radius: 8px; overflow: hidden;';
                        videoDiv.innerHTML = `<video controls style="width: 100%;" src="${e.target.result}"></video>`;
                        preview.appendChild(videoDiv);
                    };
                    reader.readAsDataURL(file);
                });
                preview.classList.add('show');
            } else {
                preview.classList.remove('show');
                preview.innerHTML = '';
            }
        }

        // 封面图片预览函数
        function previewCover(input, previewId) {
            const preview = document.getElementById(previewId);
            const file = input.files[0];

            if (file) {
                // 检查文件大小（增加到2MB限制）
                const fileSizeMB = file.size / 1024 / 1024;

                if (fileSizeMB > 2) {
                    alert('❌ 错误：图片大小超过2MB，请压缩后上传！\n\n当前大小：' + fileSizeMB.toFixed(2) + 'MB');
                    input.value = ''; // 清空选择
                    preview.classList.remove('show');
                    preview.innerHTML = '';
                    return;
                } else if (fileSizeMB > 1) {
                    alert('⚠️ 提示：图片较大（超过1MB），上传可能需要几秒钟。');
                }

                const reader = new FileReader();
                reader.onload = function (e) {
                    preview.innerHTML = `<img src="${e.target.result}" alt="封面预览" style="max-width: 100%; height: auto; border-radius: 8px;">
                        <p style="margin-top: 10px; color: #666; font-size: 0.9rem;">文件大小: ${(fileSizeMB).toFixed(2)}MB</p>`;
                    preview.classList.add('show');
                };
                reader.readAsDataURL(file);
            } else {
                preview.classList.remove('show');
                preview.innerHTML = '';
            }
        }

        // 保存新闻 - 支持多文件上传
        function saveNews() {
            const form = document.getElementById('newsForm');
            const formData = new FormData(form);

            // 处理多文件上传
            const coverFile = document.getElementById('newsCoverImage').files[0];
            const imageFiles = Array.from(document.getElementById('newsImage').files);
            const videoFiles = Array.from(document.getElementById('newsVideo').files);

            // 处理参与人员和工作人员
            const participantsList = formData.get('participantsList');
            const staffList = formData.get('staffList');

            const participantsArray = participantsList ? participantsList.split('\n').filter(item => item.trim()) : [];
            const staffArray = staffList ? staffList.split('\n').filter(item => item.trim()) : [];

            // 创建新闻数据对象
            const newsData = {
                id: Date.now().toString(36) + Math.random().toString(36).slice(2, 8),
                createdAt: Date.now(),
                title: formData.get('title'),
                subtitle: formData.get('subtitle') || '', // 添加副标题
                content: formData.get('content'),
                date: formData.get('date'),
                time: formData.get('time') || '',
                location: formData.get('location'),
                organizer: formData.get('organizer'),
                coOrganizer: formData.get('coOrganizer') || '',
                coreFunction: formData.get('coreFunction'),
                highlights: formData.get('highlights'),
                eventGoal: formData.get('eventGoal') || '',
                participants: formData.get('participants') || '',
                eventScale: formData.get('eventScale') || '',
                eventFee: formData.get('eventFee') || '',
                category: formData.get('category') || '活动新闻',
                coverImage: null, // 封面图片
                images: [], // 改为数组
                videos: [],  // 改为数组
                participantsList: participantsArray,
                staffList: staffArray
            };

            // 计数器，确保所有文件处理完成
            let processedCount = 0;
            const totalFiles = (coverFile ? 1 : 0) + imageFiles.length + videoFiles.length;
            const totalOperations = Math.max(totalFiles, 1); // 至少执行1次

            function checkAndProcess() {
                processedCount++;
                console.log(`⏳ 处理进度: ${processedCount}/${totalOperations}, 总文件数: ${totalFiles}`);
                if (processedCount >= totalOperations) {
                    // 转换为适合API的格式
                    console.log(`📊 文件处理完成:`);
                    console.log(`  - 图片数量: ${newsData.images.length}`);
                    console.log(`  - 视频数量: ${newsData.videos.length}`);
                    newsData.image = newsData.images.length > 0 ? newsData.images : '';
                    newsData.video = newsData.videos.length > 0 ? newsData.videos : '';
                    processNewsData(newsData);
                }
            }

            // 如果没有任何文件，直接处理
            if (totalFiles === 0) {
                checkAndProcess();
            } else {
                // 处理封面图片
                if (coverFile) {
                    const reader = new FileReader();
                    reader.onload = function (e) {
                        newsData.coverImage = e.target.result;
                        console.log('封面图片已加载');
                        checkAndProcess();
                    };
                    reader.onerror = function (e) {
                        console.error('封面图片加载失败:', e);
                        checkAndProcess();
                    };
                    reader.readAsDataURL(coverFile);
                }

                // 处理所有图片文件
                if (imageFiles.length > 0) {
                    console.log(`📷 开始处理 ${imageFiles.length} 张图片`);
                    imageFiles.forEach((file, index) => {
                        const reader = new FileReader();
                        reader.onload = function (e) {
                            newsData.images.push(e.target.result);
                            console.log(`✅ 图片 ${index + 1}/${imageFiles.length} 已加载，大小: ${(e.target.result.length / 1024).toFixed(2)}KB`);
                            checkAndProcess();
                        };
                        reader.onerror = function (e) {
                            console.error(`❌ 图片 ${index + 1} 加载失败:`, e);
                            checkAndProcess();
                        };
                        reader.readAsDataURL(file);
                    });
                } else {
                    console.log('ℹ️ 没有上传图片');
                }

                // 处理所有视频文件
                if (videoFiles.length > 0) {
                    videoFiles.forEach((file, index) => {
                        const reader = new FileReader();
                        reader.onload = function (e) {
                            newsData.videos.push(e.target.result);
                            console.log(`视频 ${index + 1} 已加载`);
                            checkAndProcess();
                        };
                        reader.onerror = function (e) {
                            console.error(`视频 ${index + 1} 加载失败:`, e);
                            checkAndProcess();
                        };
                        reader.readAsDataURL(file);
                    });
                }
            }
        }

        // 处理新闻数据
        async function processNewsData(newsData) {
            // 验证表单
            if (!newsData.title || !newsData.content || !newsData.date || !newsData.location || !newsData.organizer || !newsData.coreFunction) {
                showNotification('请填写所有必填字段！', 'error');
                return;
            }

            try {
                let response, result;

                if (currentEditingNews !== null) {
                    // 编辑模式 - 调用API更新
                    const oldNews = news[currentEditingNews];
                    const updateData = {
                        title: newsData.title,
                        subtitle: newsData.subtitle || '', // 添加副标题
                        content: newsData.content,
                        event_date: newsData.date,
                        event_time: newsData.time || '',
                        location: newsData.location,
                        organizer: newsData.organizer,
                        co_organizer: newsData.coOrganizer || '',
                        core_function: newsData.coreFunction,
                        highlights: newsData.highlights || '',
                        event_goal: newsData.eventGoal || '',
                        participants: newsData.participants || '',
                        event_scale: newsData.eventScale || '',
                        event_fee: newsData.eventFee || '',
                        category: newsData.category || '活动新闻',
                        cover_image: newsData.coverImage || '',
                        image: newsData.image || '',
                        video: newsData.video || '',
                        participants_list: newsData.participantsList || [],
                        staff_list: newsData.staffList || []
                    };

                    response = await fetch(`api/manage-data.php?type=news&id=${oldNews.id}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(updateData)
                    });
                    result = await response.json();

                    if (result.success) {
                        news[currentEditingNews] = newsData;
                        addLog('update', '编辑新闻', `编辑新闻: "${newsData.title}" (时间: ${newsData.date} ${newsData.time})`);
                        showNotification('新闻更新成功！', 'success');
                    } else {
                        throw new Error(result.message || '更新失败');
                    }
                } else {
                    // 添加模式 - 调用API创建
                    const newData = {
                        title: newsData.title,
                        subtitle: newsData.subtitle || '', // 添加副标题
                        content: newsData.content,
                        event_date: newsData.date,
                        event_time: newsData.time || '',
                        location: newsData.location,
                        organizer: newsData.organizer,
                        co_organizer: newsData.coOrganizer || '',
                        core_function: newsData.coreFunction,
                        highlights: newsData.highlights || '',
                        event_goal: newsData.eventGoal || '',
                        participants: newsData.participants || '',
                        event_scale: newsData.eventScale || '',
                        event_fee: newsData.eventFee || '',
                        category: newsData.category || '活动新闻',
                        cover_image: newsData.coverImage || '',
                        image: newsData.image || '',
                        video: newsData.video || '',
                        participants_list: newsData.participantsList || [],
                        staff_list: newsData.staffList || []
                    };

                    response = await fetch('api/manage-data.php?type=news', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(newData)
                    });
                    result = await response.json();

                    if (result.success) {
                        const newNews = {
                            ...newsData,
                            id: result.data.id,
                            createdAt: Date.now()
                        };

                        news.push(newNews);
                        addLog('create', '添加新闻', `添加新闻: "${newsData.title}" (时间: ${newsData.date} ${newsData.time})`);
                        showNotification('新闻添加成功！', 'success');
                    } else {
                        throw new Error(result.message || '添加失败');
                    }
                }

                // 重新加载数据
                await loadData();
                updateNewsDisplay();
                updateStats();
                closeModal('newsModal');

            } catch (error) {
                console.error('保存新闻失败:', error);
                showNotification('保存新闻失败: ' + error.message, 'error');
            }
        }

        // 编辑文章
        function editArticle(index) {
            openArticleModal(index);
        }

        // 编辑新闻
        function editNews(index) {
            openNewsModal(index);
        }

        // 删除文章
        async function deleteArticle(index) {
            if (confirm('确定要删除这篇文章吗？')) {
                const deletedArticle = articles[index];

                try {
                    console.log('正在删除文章 ID:', deletedArticle.id);
                    const response = await fetch(`api/manage-data.php?type=articles&id=${deletedArticle.id}`, {
                        method: 'DELETE'
                    });

                    console.log('API响应状态:', response.status);

                    // 先获取原始文本，以便调试
                    const text = await response.text();
                    console.log('API原始响应:', text);

                    // 尝试解析JSON
                    let result;
                    try {
                        result = JSON.parse(text);
                    } catch (e) {
                        console.error('JSON解析失败，原始响应:', text);
                        throw new Error('服务器返回了无效的响应格式');
                    }

                    if (result.success) {
                        articles.splice(index, 1);
                        addLog('delete', '删除文章', `删除文章: "${deletedArticle.title}" (分类: ${deletedArticle.category})`);
                        await loadData();
                        updateArticlesDisplay();
                        updateStats();
                        showNotification('文章已删除！', 'success');
                    } else {
                        throw new Error(result.message || '删除失败');
                    }
                } catch (error) {
                    console.error('删除文章失败:', error);
                    showNotification('删除文章失败: ' + error.message, 'error');
                }
            }
        }

        // 删除新闻
        async function deleteNews(index) {
            if (confirm('确定要删除这条新闻吗？')) {
                const deletedNews = news[index];

                try {
                    const response = await fetch(`api/manage-data.php?type=news&id=${deletedNews.id}`, {
                        method: 'DELETE'
                    });
                    const result = await response.json();

                    if (result.success) {
                        news.splice(index, 1);
                        addLog('delete', '删除新闻', `删除新闻: "${deletedNews.title}" (时间: ${deletedNews.date} ${deletedNews.time})`);
                        await loadData();
                        updateNewsDisplay();
                        updateStats();
                        showNotification('新闻已删除！', 'success');
                    } else {
                        throw new Error(result.message || '删除失败');
                    }
                } catch (error) {
                    console.error('删除新闻失败:', error);
                    showNotification('删除新闻失败: ' + error.message, 'error');
                }
            }
        }

        // 设置默认日期
        function setDefaultDate() {
            return new Promise((resolve) => {
                const today = new Date().toISOString().split('T')[0];
                document.getElementById('articleDate').value = today;
                document.getElementById('newsDate').value = today;

                // 模拟异步操作完成
                setTimeout(resolve, 10);
            });
        }

        // 标签页切换
        function switchTab(tabName) {
            // 权限检查
            if (tabName === 'logs' && !hasPermission(PERMISSIONS.SUPER_ADMIN)) {
                showNotification('权限不足！只有超级管理员可以查看日志', 'error');
                return;
            }

            // 活动展示权限检查
            if (tabName === 'activities' && !hasPermission(PERMISSIONS.SUPER_ADMIN)) {
                showNotification('权限不足！只有超级管理员可以查看活动展示', 'error');
                return;
            }

            // 移除所有标签页的active类
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });

            document.querySelectorAll('.admin-card').forEach(card => {
                card.classList.remove('active');
                card.style.display = 'none';
            });

            // 激活选中的标签页
            const tabBtn = document.querySelector(`[data-tab="${tabName}"]`);
            const tabCard = document.getElementById(`${tabName}Tab`);

            // 如果是活动展示标签，加载活动数据
            if (tabName === 'activities') {
                loadActivitiesView();
            }

            if (tabBtn) {
                tabBtn.classList.add('active');
            }

            if (tabCard) {
                tabCard.classList.add('active');
                // 使用 !important 强制显示
                tabCard.style.cssText = 'display: block !important;';
            }

            // 如果是日志页面，渲染日志
            if (tabName === 'logs') {
                console.log('切换到日志页面');
                renderLogs();
            }

            // 更新统计信息（可选）
            updateStats();
        }

        // 加载活动展示视图
        async function loadActivitiesView() {
            const activitiesList = document.getElementById('activitiesList');

            // 显示加载状态
            activitiesList.innerHTML = '<div class="empty-state"><i class="fas fa-spinner fa-spin"></i><h3>加载中...</h3></div>';

            try {
                console.log('开始加载活动数据...');

                // 从API获取数据
                const response = await fetch('api/get-data.php?type=all');
                console.log('API响应状态:', response.status);

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const result = await response.json();
                console.log('获取到的原始数据:', result);

                // 处理不同的数据结构
                console.log('API返回的完整结果:', JSON.stringify(result).substring(0, 500));

                let data = result;
                // 检查是否有success字段包装
                if (result.success !== undefined) {
                    if (result.success && result.data) {
                        data = result.data;
                        console.log('数据被包装在success字段中，已解包');
                    }
                }

                // 尝试从result中直接获取news数组
                let newsData = data.news;
                if (!newsData && result.data && result.data.news) {
                    newsData = result.data.news;
                    console.log('从result.data中获取news');
                }

                console.log('处理后的数据:', data);
                console.log('新闻数组:', newsData);
                console.log('新闻数量:', newsData ? newsData.length : 0);

                if (!newsData || newsData.length === 0) {
                    console.log('没有新闻数据，当前数据:', data);
                    activitiesList.innerHTML = `
                        <div class="empty-state">
                            <i class="fas fa-calendar-alt"></i>
                            <h3>暂无活动</h3>
                            <p>在"新闻管理"中添加活动</p>
                        </div>
                    `;
                    return;
                }

                // 显示所有新闻（不过滤）
                const activities = newsData;
                console.log('活动数量（显示全部）:', activities.length);

                if (activities.length === 0) {
                    console.log('活动列表为空');
                    activitiesList.innerHTML = `
                        <div class="empty-state">
                            <i class="fas fa-calendar-alt"></i>
                            <h3>暂无活动</h3>
                            <p>在"新闻管理"中添加活动</p>
                        </div>
                    `;
                    return;
                }

                // 渲染活动卡片
                console.log('开始渲染活动卡片，共', activities.length, '个活动');
                activitiesList.innerHTML = activities.map(activity => {
                    console.log('渲染活动:', activity.title, 'ID:', activity.id);

                    // 优先使用封面图
                    let imageUrl = '';
                    if (activity.cover_image) {
                        imageUrl = activity.cover_image;
                    } else if (activity.coverImage) {
                        imageUrl = activity.coverImage;
                    } else if (activity.image) {
                        if (Array.isArray(activity.image) && activity.image.length > 0) {
                            imageUrl = activity.image[0];
                        } else if (typeof activity.image === 'string') {
                            imageUrl = activity.image;
                        }
                    }

                    console.log('活动图片URL:', imageUrl);

                    return `
                        <div class="activity-card-admin" style="background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.1); transition: transform 0.3s ease, box-shadow 0.3s ease; cursor: pointer;" onmouseover="this.style.transform='translateY(-5px)'; this.style.boxShadow='0 4px 16px rgba(0,0,0,0.15)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 8px rgba(0,0,0,0.1)'" onclick="window.open('admin-activity-detail.html?id=${activity.id}', '_blank')">
                            ${imageUrl ? `<img src="${imageUrl}" alt="${activity.title}" style="width: 100%; height: 200px; object-fit: cover;" onerror="console.error('图片加载失败:', '${imageUrl}')">` : ''}
                            <div style="padding: 20px;">
                                <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 12px;">
                                    <span style="background: #667eea; color: white; padding: 4px 12px; border-radius: 12px; font-size: 0.85rem; font-weight: 500;">${activity.category || '活动新闻'}</span>
                                    <span style="color: #666; font-size: 0.85rem;">${activity.date} ${activity.time || ''}</span>
                                </div>
                                <h3 style="margin: 0 0 10px 0; color: #2D3748; font-size: 1.1rem; font-weight: 600; line-height: 1.4;">${activity.title}</h3>
                                ${activity.subtitle ? `<p style="margin: 0 0 10px 0; color: #4A5568; font-size: 0.9rem; line-height: 1.5;">${activity.subtitle}</p>` : ''}
                                <div style="display: flex; flex-direction: column; gap: 6px; margin-top: 12px;">
                                    <div style="display: flex; align-items: center; gap: 6px; color: #718096; font-size: 0.85rem;">
                                        <i class="fas fa-map-marker-alt"></i>
                                        <span>${activity.location || '韩国中心'}</span>
                                    </div>
                                    ${activity.organizer ? `
                                    <div style="display: flex; align-items: center; gap: 6px; color: #718096; font-size: 0.85rem;">
                                        <i class="fas fa-users"></i>
                                        <span>${activity.organizer}</span>
                                    </div>
                                    ` : ''}
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');

                console.log('活动渲染完成');

            } catch (error) {
                console.error('加载活动失败:', error);
                activitiesList.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-exclamation-circle"></i>
                        <h3>加载失败</h3>
                        <p>${error.message}</p>
                        <p style="margin-top: 10px; font-size: 0.85rem; color: #999;">请检查浏览器控制台查看详细错误信息</p>
                    </div>
                `;
            }
        }

        // 显示通知
        function showNotification(message, type = 'info') {
            // 创建通知元素
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;

            document.body.appendChild(notification);

            // 3秒后自动移除
            setTimeout(() => {
                document.body.removeChild(notification);
            }, 3000);
        }

        // 点击模态框外部关闭（已禁用，防止意外关闭）
        document.addEventListener('click', function (e) {
            // 禁用所有模态框的点击外部关闭功能，只能通过取消按钮关闭
            // 这样可以防止用户在填写表单时意外关闭模态框
        });

        // ESC键关闭模态框（已禁用，防止意外关闭）
        document.addEventListener('keydown', function (e) {
            // 禁用所有模态框的ESC键关闭功能，只能通过取消按钮关闭
            // 这样可以防止用户在填写表单时意外关闭模态框
        });
    </script>
</body>

</html>